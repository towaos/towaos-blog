---
import { getCollection } from 'astro:content';
import BlogLayout from '../../../layouts/BlogLayout.astro';
import SearchBar from '../../../components/SearchBar.astro';
import PostList from '../../../components/PostList.astro';
import Pagination from '../../../components/Pagination.astro';
import SearchScript from '../../../components/SearchScript.astro';
import { getPaginatedPosts, getTotalPages, sortPostsByDate } from '../../../lib/pagination';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const tagsMap = new Map<string, any[]>();
  
  // タグごとに投稿を分類
  allPosts.forEach(post => {
    post.data.tags.forEach(tag => {
      if (!tagsMap.has(tag)) {
        tagsMap.set(tag, []);
      }
      tagsMap.get(tag)!.push(post);
    });
  });

  return Array.from(tagsMap.entries()).map(([tag, posts]) => {
    const sortedPosts = sortPostsByDate(posts);
    const totalPages = getTotalPages(sortedPosts.length);

    return {
      params: { name: tag.toLowerCase() },
      props: {
        tag,
        posts: getPaginatedPosts(sortedPosts, 1),
        currentPage: 1,
        totalPages,
        totalPosts: sortedPosts.length,
      },
    };
  });
}

const { tag, posts, currentPage, totalPages, totalPosts } = Astro.props;
---

<BlogLayout title={`Tag: ${tag}`} description={`${tag}タグの投稿`}>
  <SearchBar 
    totalPosts={totalPosts}
    tagName={tag}
    currentPage={currentPage}
    totalPages={totalPages}
  />

  <div class="layout">
    <PostList posts={posts} title={`Posts tagged with "${tag}"`} />

    <article class="panel" aria-label="Post detail">
      <div class="content">
        <div class="empty">投稿を選んでね。</div>
      </div>
    </article>
  </div>

  <Pagination 
    currentPage={currentPage}
    totalPages={totalPages}
    baseUrl={`/tags/${tag.toLowerCase()}`}
  />

  <SearchScript />
</BlogLayout>
