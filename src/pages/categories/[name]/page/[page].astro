---
import { getCollection } from 'astro:content';
import BlogLayout from '../../../../layouts/BlogLayout.astro';
import SearchBar from '../../../../components/SearchBar.astro';
import PostList from '../../../../components/PostList.astro';
import Pagination from '../../../../components/Pagination.astro';
import SearchScript from '../../../../components/SearchScript.astro';
import { getPaginatedPosts, getTotalPages, sortPostsByDate } from '../../../../lib/pagination';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const categoriesMap = new Map<string, any[]>();
  
  // カテゴリごとに投稿を分類
  allPosts.forEach(post => {
    const category = post.data.category;
    if (!categoriesMap.has(category)) {
      categoriesMap.set(category, []);
    }
    categoriesMap.get(category)!.push(post);
  });

  const paths: any[] = [];

  // 各カテゴリの2ページ目以降を生成
  categoriesMap.forEach((posts, category) => {
    const sortedPosts = sortPostsByDate(posts);
    const totalPages = getTotalPages(sortedPosts.length);

    for (let page = 2; page <= totalPages; page++) {
      paths.push({
        params: { 
          name: category.toLowerCase(),
          page: String(page)
        },
        props: {
          category,
          posts: getPaginatedPosts(sortedPosts, page),
          currentPage: page,
          totalPages,
          totalPosts: sortedPosts.length,
        },
      });
    }
  });

  return paths;
}

const { category, posts, currentPage, totalPages, totalPosts } = Astro.props;
---

<BlogLayout title={`Category: ${category} - Page ${currentPage}`} description={`${category}カテゴリーの投稿 - ページ ${currentPage}`}>
  <SearchBar 
    totalPosts={totalPosts}
    categoryName={category}
    currentPage={currentPage}
    totalPages={totalPages}
  />

  <div class="layout">
    <PostList posts={posts} title={`Posts in "${category}" (Page ${currentPage})`} />

    <article class="panel" aria-label="Post detail">
      <div class="content">
        <div class="empty">投稿を選んでね。</div>
      </div>
    </article>
  </div>

  <Pagination 
    currentPage={currentPage}
    totalPages={totalPages}
    baseUrl={`/categories/${category.toLowerCase()}`}
  />

  <SearchScript />
</BlogLayout>
